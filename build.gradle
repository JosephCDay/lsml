apply plugin: 'application'
apply plugin: 'launch4j'
apply plugin: 'java'
apply plugin: 'findbugs'
apply plugin: 'jacoco'

allprojects {
	sourceCompatibility = 1.8
	targetCompatibility = 1.8
}

/* ----------------------------------------------------------------------------
 * Build configuration
 * --------------------------------------------------------------------------*/
buildDir = 'build/gradle'
libsDirName = project.rootDir.toString() + '/lib'

/* ----------------------------------------------------------------------------
 * General project configuration
 * --------------------------------------------------------------------------*/
applicationName = 'Li Song Mechlab'
archivesBaseName = 'lsml'
mainClassName = 'org.lisoft.lsml.view_fx.LiSongMechLab'
[compileJava, compileTestJava]*.options*.encoding = 'UTF-8'

/* ----------------------------------------------------------------------------
 * Dependencies
 * --------------------------------------------------------------------------*/
repositories {
	jcenter()
}

dependencies {
	compile 'com.thoughtworks.xstream:xstream:1.4.7+',
			'net.java.dev.jna:jna:4.0.0+',
			'com.squareup.dagger:dagger:1.2+'

	testCompile 'junit:junit:4+', 
				'org.mockito:mockito-all:1.10.19+', 
				'pl.pragmatists:JUnitParams:1.0.2+'
}

gradle.taskGraph.whenReady { taskGraph ->
	if (!taskGraph.hasTask(release)) {
		version = '(develop)'
	}
}

/* ----------------------------------------------------------------------------
 * Release Management
 * --------------------------------------------------------------------------*/
task release << {
	println "Building release: " + version
}

jar {
	destinationDir = file('build')
	from { 
		configurations.compile.collect { 
			it.isDirectory() ? it : zipTree(it) 
		} 
	}
	
	archiveName="lsml.jar"

	if(version == null){
		version = '0.0.0'
	}

	manifest {
		attributes(	'Main-Class': mainClassName, 
					'Implementation-Title': 'Li Song Mechlab', 
					'Implementation-Version' : version)
	}
}

launch4j {
	println project.targetCompatibility
	jreMinVersion = "1.8.0_77"
	mainClassName = project.mainClassName
	dontWrapJar = true
	outputDir = '../'
	icon = project.jar.destinationDir.toString() + '/icon.ico'
	jar = project.jar.archiveName
	manifest = project.jar.destinationDir.toString() + '/lsml.manifest'
}

buildscript {
	repositories {
		jcenter()
	}
	dependencies {
		classpath 'edu.sc.seis.gradle:launch4j:1.0.6+'
	}
}

task wixCandle64(type: Exec) {
	workingDir 'build'
	executable 'candle'
	args '-dg_64bit="yes"', '-dg_version=' + version, '"*.wxs"'
}

task wixLight64(type: Exec) {
	workingDir 'build'
	executable 'light'
	args '-ext', 'WixUIExtension', '"*.wixobj"', '-out', 'LSML_Setup-'+version+'_64bit.msi'
}

task wixCandle32(type: Exec) {
	workingDir 'build'
	executable 'candle'
	args '-dg_64bit="no"', '-dg_version=' + version, '"*.wxs"'
}

task wixLight32(type: Exec) {
	workingDir 'build'
	executable 'light'
	args '-ext', 'WixUIExtension', '"*.wixobj"', '-out', 'LSML_Setup-'+version+'_32bit.msi'
}

wixLight64.dependsOn(wixCandle64);
wixLight32.dependsOn(wixCandle32);
release.dependsOn(jar)
release.dependsOn('launch4j')
release.dependsOn(wixLight32)
release.dependsOn(wixLight64)

tasks.withType(FindBugs) {
    reports {
        xml.enabled false
        html.enabled true
     }
}

findbugs {
    excludeFilter = file("$rootProject.projectDir/findbugsExclude.xml")
}

jacocoTestReport {
    reports {
        xml.enabled = true
        html.enabled = true
    }
}

check.dependsOn jacocoTestReport